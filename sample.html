<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="description" content="">
	<meta name="author" content="">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
	<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
	<script src="https://cdn.jsdelivr.net/gh/vcd94xt10z/consulta-frete/freight.js"></script>
	<title>Exemplo</title>
	<script>
	var index 	    = 1;
	var ajaxRunning = false;
	
	function showMessage(message,type){
		$("#alert-success").html("").css("display","none");
		$("#alert-error").html("").css("display","none");
		
		if(type.toLowerCase() == "s"){
			$("#alert-success").html(message).css("display","block");
		}else{
			$("#alert-error").html(message).css("display","block");
		}
	}
	
	function onCalc1(){
		if(ajaxRunning){
			return;
		}
		ajaxRunning = true;

		var input = getFormData();
		let button1 = $("#button-calc1");
		
		button1.html("Aguarde");
		$("#table1 tbody").html("");
		
		var promise = Freight.calcSync(input);
		promise.then(function(data){
			ajaxRunning	= false;
			button1.html("Calcular (1 Passo)");
			
			for(let i in data.result){
				renderCarrierResult(data.result[i]);
			}
		}).catch(function(xhr){
			ajaxRunning	= false;
			button1.html("Calcular (1 Passo)");
			
			var message = xhr.responseText;
			if(message != undefined && message != ""){
				showMessage(message,"e");	
			}else{
				showMessage("Erro em calcular frete",'e');
			}
		});
	}

	function onCalc2(){
		if(ajaxRunning){
			return;
		}
		ajaxRunning = true;
		
		var input = getFormData();
		let button2 = $("#button-calc2");
		
		button2.html("Aguarde");
		$("#table1 tbody").html("");
		
		Freight.calcAll(input,renderCarrierResult,function(){
			ajaxRunning = false;
			button2.html("Calcular (N Passos)");
		});
	}
	
	function renderCarrierResult(carrierObj){
		if(carrierObj.status == 'S'){
			for(var i in carrierObj.result){
				var item = carrierObj.result[i];
				renderProductResult(item);
			}
		}else{
			renderProductResult({
				carrierid: carrierObj.carrierid,
				status: 'E',
				product: {
					id: "",
					name: ""
				},
				deliveryDays: 0,
				price: 0,
				errorCode: "",
				message: carrierObj.message
			});
		}
	}
	
	function renderProductResult(item){
		let code = "";
		code += "<tr>";
			code += "<td>"+index+"</td>";
			code += "<td>"+item.status+"</td>";
			code += "<td>"+item.carrierid+"</td>";
			code += "<td>"+item.product.name+"</td>";
			code += "<td>"+item.deliveryDays+" dias</td>";
			code += "<td>"+item.price+"</td>";
			code += "<td>";
			if(item.status = 'E'){
				code += item.errorCode+" "+item.message;
			}else{
				code += item.message;
			}
			code += "</td>";
		code += "</tr>";
		index++;
		
		$("#table1 tbody").append(code);
	}

	function getFormData(){
		let zipcode = $("#zipcode").val();
		let total = $("#total").val();
		let weight = $("#weight").val();
		let width = $("#width").val();
		let height = $("#height").val();
		let length = $("#length").val();
		let diameter = $("#diameter").val();
		
		let input = {
			"zipcode": zipcode,
			"total": parseFloat(total),
			"weight": parseFloat(weight),
			"width": parseFloat(width),
			"height": parseFloat(height),
			"length": parseFloat(length),
			"diameter": parseFloat(diameter)
		};
		
		return input;
	}

	$(document).ready(function(){
		$("#button-calc1").click(function(){
			onCalc1();
		});
		
		$("#button-calc2").click(function(){
			onCalc2();
		});
	});
	</script>
</head>
<body>
	
	<div class="container">
		<br>
		
		<div id="alert-success" class="alert alert-success" role="alert" style="display:none"></div>
		<div id="alert-error" class="alert alert-danger" role="alert" style="display:none"></div>
		
		<div class="row">
			<div class="col-4">
				<h2>Par√¢metros</h2>
				<form>
				  <div class="form-group row">
					<label for="zipcode" class="col-12 col-form-label">
						CEP
					</label>
					<div class="col-12">
					  <input id="zipcode" name="zipcode" type="text" class="form-control" required="required" value="04180112">
					</div>
				  </div>
				  <div class="form-group row">
					<label for="total" class="col-12 col-form-label">
						Valor Total
					</label> 
					<div class="col-12">
					  <input id="total" name="total" type="text" class="form-control" aria-describedby="totalHelpBlock" value="300.05"> 
					</div>
				  </div>
				  <div class="form-group row">
					<label for="weight" class="col-12 col-form-label">
						Peso
					</label> 
					<div class="col-12">
					  <input id="weight" name="weight" type="text" class="form-control" aria-describedby="pesoHelpBlock" value="2"> 
					</div>
				  </div>
				  <div class="form-group row">
					<label for="width" class="col-12 col-form-label">Largura</label> 
					<div class="col-12">
					  <input id="width" name="width" type="text" class="form-control" aria-describedby="pesoHelpBlock" value="14">
					</div>
				  </div>
				  <div class="form-group row">
					<label for="height" class="col-12 col-form-label">Altura</label> 
					<div class="col-12">
					  <input id="height" name="height" type="text" class="form-control" aria-describedby="pesoHelpBlock" value="4">
					</div>
				  </div>
				  <div class="form-group row">
					<label for="length" class="col-12 col-form-label">Comprimento</label> 
					<div class="col-12">
					  <input id="length" name="length" type="text" class="form-control" aria-describedby="pesoHelpBlock" value="18">
					</div>
				  </div>
				  <div class="form-group row">
					<label for="diameter" class="col-12 col-form-label">Diametro</label> 
					<div class="col-12">
					  <input id="diameter" name="diameter" type="text" class="form-control" aria-describedby="pesoHelpBlock" value="10">
					</div>
				  </div>
				  <div class="form-group row">
					<div class="col-12">
					  <button id="button-calc1" type="button" class="btn btn-primary">Calcular (1 Passo)</button>
					  <button id="button-calc2" type="button" class="btn btn-primary">Calcular (N Passos)</button>
					</div>
				  </div>
				</form>
			</div>
			<div class="col-8">
				<h2>Resultado</h2>
				<br>
				
				<div class="table-responsive">
				<table id="table1" class="table table-striped table-hover table-bordered table-sm">
					<thead>
					<tr>
						<td>#</td>
						<td>Status</td>
						<td>Transportadora</td>
						<td>Produto</td>
						<td>Tempo de Entrega</td>
						<td>Valor do Frete</td>
						<td>Mensagem</td>
					</tr>
					</thead>
					<tbody></tbody>
				</table>
				</div>
				
			</div>
		</div>
		
	</div>
	
  </body>
</html>